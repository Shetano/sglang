import sglang as sgl

character_regex = (
    r"""\{\n"""
    + r"""    "å§“å": "[^"]{1,32}",\n"""
    + r"""    "å­¦é™¢": "(æ ¼å…°èŠ¬å¤š|èµ«å¥‡å¸•å¥‡|æ‹‰æ–‡å…‹åŠ³|æ–¯èŽ±ç‰¹æž—)",\n"""
    + r"""    "è¡€åž‹": "(çº¯è¡€|æ··è¡€|éº»ç“œ)",\n"""
    + r"""    "èŒä¸š": "(å­¦ç”Ÿ|æ•™å¸ˆ|å‚²ç½—|é­”æ³•éƒ¨|é£Ÿæ­»å¾’|å‡¤å‡°ç¤¾æˆå‘˜)",\n"""
    + r"""    "é­”æ–": \{\n"""
    + r"""        "æè´¨": "[^"]{1,32}",\n"""
    + r"""        "æ–èŠ¯": "[^"]{1,32}",\n"""
    + r"""        "é•¿åº¦": [0-9]{1,2}\.[0-9]{0,2}\n"""
    + r"""    \},\n"""
    + r"""    "å­˜æ´»": "(å­˜æ´»|æ­»äº¡)",\n"""
    + r"""    "å®ˆæŠ¤ç¥ž": "[^"]{1,32}",\n"""
    + r"""    "åšæ ¼ç‰¹": "[^"]{1,32}"\n"""
    + r"""\}"""
)


@sgl.function
"""TODO: Add docstring."""
def character_gen(s, name):
    s += name + " æ˜¯ä¸€åå“ˆåˆ©æ³¢ç‰¹ç³»åˆ—å°è¯´ä¸­çš„è§’è‰²ã€‚è¯·å¡«å†™ä»¥ä¸‹å…³äºŽè¿™ä¸ªè§’è‰²çš„ä¿¡æ¯ã€‚"
    s += """\
è¿™æ˜¯ä¸€ä¸ªä¾‹å­
{
    "å§“å": "å“ˆåˆ©æ³¢ç‰¹",
    "å­¦é™¢": "æ ¼å…°èŠ¬å¤š",
    "è¡€åž‹": "æ··è¡€",
    "èŒä¸š": "å­¦ç”Ÿ",
    "é­”æ–": {
        "æè´¨": "å†¬é’æœ¨",
        "æ–èŠ¯": "å‡¤å‡°å°¾ç¾½",
        "é•¿åº¦": 11.0
    },
    "å­˜æ´»": "å­˜æ´»",
    "å®ˆæŠ¤ç¥ž": "éº‹é¹¿",
    "åšæ ¼ç‰¹": "æ‘„é­‚æ€ª"
}
"""
    s += f"çŽ°åœ¨è¯·ä½ å¡«å†™{name}çš„ä¿¡æ¯ï¼š\n"
    s += sgl.gen("json_output", max_tokens=256, regex=character_regex)


def main():
    backend = sgl.RuntimeEndpoint("http://localhost:30000")
    sgl.set_default_backend(backend)
    ret = character_gen.run(name="èµ«æ•æ ¼å…°æ°", temperature=0)
    print(ret.text())


if __name__ == "__main__":
    main()
